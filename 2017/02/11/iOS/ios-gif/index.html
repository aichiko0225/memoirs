<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>iOS GIF图片的加载和合成 | ash</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="写在前面的 不拘一世之利以为己私分，不以王天下为已处显。显则明。万物一府，死生同状。">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS GIF图片的加载和合成">
<meta property="og:url" content="https://aichiko0225.github.com/memoirs/2017/02/11/iOS/ios-gif/index.html">
<meta property="og:site_name" content="ash">
<meta property="og:description" content="写在前面的 不拘一世之利以为己私分，不以王天下为已处显。显则明。万物一府，死生同状。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2478081-34221564e9b2bd12.jpg">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2478081-46f07bf71f2f7f15.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/300">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2478081-06f5970b7ff51964.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/300">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2478081-df10989d1514fa0e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2478081-fa8bf6dab9678aca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/300">
<meta property="article:published_time" content="2017-02-10T16:00:00.000Z">
<meta property="article:modified_time" content="2020-02-03T12:46:46.154Z">
<meta property="article:author" content="ash">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/2478081-34221564e9b2bd12.jpg">
  
    <link rel="alternate" href="/memoirs/atom.xml" title="ash" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/memoirs/favicon.png">
  
  
  
<link rel="stylesheet" href="/memoirs/css/style.css">

  
    
<link rel="stylesheet" href="/memoirs/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/memoirs/" id="logo">ash</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/memoirs/" id="subtitle">我只是一个影子，虽然我发着光。。。</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/memoirs/">Home</a>
        
          <a class="main-nav-link" href="/memoirs/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/memoirs/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://aichiko0225.github.com/memoirs"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-iOS/ios-gif" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/memoirs/2017/02/11/iOS/ios-gif/" class="article-date">
  <time class="dt-published" datetime="2017-02-10T16:00:00.000Z" itemprop="datePublished">2017-02-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/memoirs/categories/iOS/">iOS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      iOS GIF图片的加载和合成
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="写在前面的"><a href="#写在前面的" class="headerlink" title="写在前面的"></a>写在前面的</h1><blockquote>
<p>不拘一世之利以为己私分，<br>不以王天下为已处显。<br>显则明。万物一府，死生同状。</p>
</blockquote>
<span id="more"></span>

<p><em>一颗伤心死掉的橘子树</em><br><img src="http://upload-images.jianshu.io/upload_images/2478081-34221564e9b2bd12.jpg" alt="那颗死掉的橘子树"></p>
<h6 id="扯淡结束开始进入文章正题"><a href="#扯淡结束开始进入文章正题" class="headerlink" title="扯淡结束开始进入文章正题"></a>扯淡结束开始进入文章正题</h6><p>iOS中GIF图片是无法像jpg，png等一样直接加载出来的，有很多的第三方库也提供了这方面的功能，这里总结一下GIF图片加载的几种方式，以及使用多张png图片合成GIF图片的方法。</p>
<h1 id="加载GIF图片"><a href="#加载GIF图片" class="headerlink" title="加载GIF图片"></a>加载GIF图片</h1><h4 id="1-使用UIWebView-WKWebView"><a href="#1-使用UIWebView-WKWebView" class="headerlink" title="1.使用UIWebView&#x2F;WKWebView"></a>1.使用UIWebView&#x2F;WKWebView</h4><p>使用UIWebView&#x2F;WKWebView相当于使用coreText 将GIF的数据编码渲染到UIWebView&#x2F;WKWebView上，使用data数据来加载，本地和网络图片差不多。</p>
<h6 id="下面使用本地图片来举例"><a href="#下面使用本地图片来举例" class="headerlink" title="下面使用本地图片来举例"></a>下面使用本地图片来举例</h6><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.使用webview来显示GIF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.view.addSubview(webview)</span><br><span class="line">webview.frame <span class="operator">=</span> <span class="keyword">self</span>.view.bounds</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> path <span class="operator">=</span> <span class="type">Bundle</span>.main.path(forResource: <span class="string">&quot;timg&quot;</span>, ofType: <span class="string">&quot;gif&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> data <span class="operator">=</span> <span class="keyword">try?</span> <span class="type">Data</span>.<span class="keyword">init</span>(contentsOf: <span class="type">URL</span>.<span class="keyword">init</span>(fileURLWithPath: path<span class="operator">!</span>)) &#123;</span><br><span class="line">    webview.load(data <span class="keyword">as</span> <span class="type">Data</span>, mimeType: <span class="string">&quot;image/gif&quot;</span>, characterEncodingName: <span class="string">&quot;UTF-8&quot;</span>, baseURL: <span class="type">Bundle</span>.main.resourceURL<span class="operator">!</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//当然也可以直接加载文件路径,下面两种load方法都可以实现</span></span><br><span class="line">webview.load(<span class="type">URLRequest</span>.<span class="keyword">init</span>(url: <span class="type">URL</span>.<span class="keyword">init</span>(fileURLWithPath: path<span class="operator">!</span>)))</span><br><span class="line">webview.loadFileURL(<span class="type">URL</span>.<span class="keyword">init</span>(fileURLWithPath: path<span class="operator">!</span>), allowingReadAccessTo: <span class="type">Bundle</span>.main.resourceURL<span class="operator">!</span>)</span><br><span class="line"><span class="comment">//OC 的写法类似，就不重复写了。</span></span><br></pre></td></tr></table></figure>

<p><img src="http://upload-images.jianshu.io/upload_images/2478081-46f07bf71f2f7f15.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/300" alt="运行效果"></p>
<h6 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h6><p>我本地的原图的宽度是500像素的，但是从上面的效果图可以看到，图片有并没有按照像素来显示，而是根据图片比例来显示，而且宽度自动为self.view的宽度。说明GIF图片数据在渲染时并不能控制图片显示的大小，以及GIF执行的帧数和运行次数。</p>
<h4 id="2-使用GIF-数据来实现"><a href="#2-使用GIF-数据来实现" class="headerlink" title="2.使用GIF 数据来实现"></a>2.使用GIF 数据来实现</h4><p>也可以使用 ImageIO 系统框架来实现GIF的播放，很多第三方开源的库也是这样做的。类似SDWebImage，Kingfisher，以及YYImage 都可以实现一句话来加载GIF图片的功能，其中Kingfisher 是swift语言，另外两个是OC的。</p>
<p>其实两种语言都一样，这边只是介绍swift语言。</p>
<p><strong>下面的方法是根据GIF的data数据来得到一个([UIImage], TimeInterval) 的元组</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - ImageIO</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">showGif</span>() -&gt;([<span class="type">UIImage</span>], <span class="type">TimeInterval</span>)<span class="operator">?</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> path <span class="operator">=</span> <span class="type">Bundle</span>.main.path(forResource: <span class="string">&quot;timg&quot;</span>, ofType: <span class="string">&quot;gif&quot;</span>)</span><br><span class="line">    <span class="keyword">let</span> data <span class="operator">=</span> <span class="keyword">try?</span> <span class="type">Data</span>.<span class="keyword">init</span>(contentsOf: <span class="type">URL</span>.<span class="keyword">init</span>(fileURLWithPath: path<span class="operator">!</span>))</span><br><span class="line">    <span class="keyword">let</span> source <span class="operator">=</span> <span class="type">CGImageSourceCreateWithData</span>(data <span class="keyword">as!</span> <span class="type">CFData</span>, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">let</span> count <span class="operator">=</span> <span class="type">CGImageSourceGetCount</span>(source<span class="operator">!</span>)</span><br><span class="line">    <span class="keyword">let</span> options: <span class="type">NSDictionary</span> <span class="operator">=</span> [kCGImageSourceShouldCache <span class="keyword">as</span> <span class="type">String</span>: <span class="literal">true</span>, kCGImageSourceTypeIdentifierHint <span class="keyword">as</span> <span class="type">String</span>: kUTTypeGIF]</span><br><span class="line">    <span class="keyword">var</span> gifDuration <span class="operator">=</span> <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">var</span> images <span class="operator">=</span> [<span class="type">UIImage</span>]()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">frameDuration</span>(<span class="params">from</span> <span class="params">gifInfo</span>: <span class="type">NSDictionary</span>) -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> gifDefaultFrameDuration <span class="operator">=</span> <span class="number">0.100</span></span><br><span class="line">        <span class="keyword">let</span> unclampedDelayTime <span class="operator">=</span> gifInfo[kCGImagePropertyGIFUnclampedDelayTime <span class="keyword">as</span> <span class="type">String</span>] <span class="keyword">as?</span> <span class="type">NSNumber</span></span><br><span class="line">        <span class="keyword">let</span> delayTime <span class="operator">=</span> gifInfo[kCGImagePropertyGIFDelayTime <span class="keyword">as</span> <span class="type">String</span>] <span class="keyword">as?</span> <span class="type">NSNumber</span></span><br><span class="line">        <span class="keyword">let</span> duration <span class="operator">=</span> unclampedDelayTime <span class="operator">??</span> delayTime</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> frameDuration <span class="operator">=</span> duration <span class="keyword">else</span> &#123; <span class="keyword">return</span> gifDefaultFrameDuration &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> frameDuration.doubleValue <span class="operator">&gt;</span> <span class="number">0.011</span> <span class="operator">?</span> frameDuration.doubleValue : gifDefaultFrameDuration</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> <span class="operator">..&lt;</span> count &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> imageRef <span class="operator">=</span> <span class="type">CGImageSourceCreateImageAtIndex</span>(source<span class="operator">!</span>, i, options) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> count <span class="operator">==</span> <span class="number">1</span> &#123;</span><br><span class="line">            <span class="comment">//只有一张图片时</span></span><br><span class="line">            gifDuration <span class="operator">=</span> <span class="type">Double</span>.infinity<span class="comment">//无穷大</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Animated GIF</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> properties <span class="operator">=</span> <span class="type">CGImageSourceCopyPropertiesAtIndex</span>(source<span class="operator">!</span>, i, <span class="literal">nil</span>), <span class="keyword">let</span> gifinfo <span class="operator">=</span> (properties <span class="keyword">as</span> <span class="type">NSDictionary</span>)[kCGImagePropertyGIFDictionary <span class="keyword">as</span> <span class="type">String</span>] <span class="keyword">as?</span> <span class="type">NSDictionary</span>  <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">            gifDuration <span class="operator">+=</span> frameDuration(from: gifinfo)</span><br><span class="line">        &#125;</span><br><span class="line">        images.append(<span class="type">UIImage</span>.<span class="keyword">init</span>(cgImage: imageRef, scale: <span class="type">UIScreen</span>.main.scale, orientation: .up))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (images, gifDuration)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在viewDidLoad 中调用下面的代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> imageView: <span class="type">UIImageView</span>?</span><br><span class="line"><span class="keyword">let</span> (images, duration) <span class="operator">=</span> showGif()<span class="operator">!</span></span><br><span class="line"><span class="keyword">let</span> animatedImage <span class="operator">=</span> <span class="type">UIImage</span>.animatedImage(with: images, duration: duration)</span><br><span class="line">imageView <span class="operator">=</span> <span class="type">UIImageView</span>.<span class="keyword">init</span>(image: animatedImage)</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.view.addSubview(imageView<span class="operator">!</span>)</span><br><span class="line">imageView<span class="operator">?</span>.center <span class="operator">=</span> <span class="keyword">self</span>.view.center</span><br></pre></td></tr></table></figure>
<p>使用<code>let animatedImage = UIImage.animatedImage(with: images, duration: duration)</code>可以创建一个动画图片，然后使用<code>imageView = UIImageView.init(image: animatedImage)</code>创建一个UIImageView? （<strong>为什么用这个方法呢，因为这个不用写imageView的width和height，会根据图片的像素自动渲染大小，不用设置大小。。。</strong>）</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2478081-06f5970b7ff51964.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/300" alt="运行效果图"></p>
<h6 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h6><p>原图的像素宽度为500，模拟器的屏幕为@2x的像素，所以图片显示大小应该是刚刚好的。这种相对于webView来显示就优化得多，也可以设置图片动画的持续时间。</p>
<p>同样的道理，我们如果用imags这个image数组 加入到ImageView动画组中，就可以设置动画的次数，就可以实现类似于新浪微博多个GIF图的微博 GIF图片会依次播放的功能。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> (images, duration) <span class="operator">=</span> showGif()<span class="operator">!</span></span><br><span class="line"><span class="comment">//let animatedImage = UIImage.animatedImage(with: images, duration: duration)</span></span><br><span class="line">imageView <span class="operator">=</span> <span class="type">UIImageView</span>.<span class="keyword">init</span>(image: images.first)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">self</span>.view.addSubview(imageView<span class="operator">!</span>)</span><br><span class="line">imageView<span class="operator">?</span>.center <span class="operator">=</span> <span class="keyword">self</span>.view.center</span><br><span class="line">        </span><br><span class="line">imageView<span class="operator">?</span>.animationImages <span class="operator">=</span> images</span><br><span class="line">imageView<span class="operator">?</span>.animationDuration <span class="operator">=</span> duration</span><br><span class="line">imageView<span class="operator">?</span>.animationRepeatCount <span class="operator">=</span> <span class="number">3</span></span><br><span class="line">imageView<span class="operator">?</span>.startAnimating()</span><br></pre></td></tr></table></figure>
<p>GIF图片的显示就介绍到这里</p>
<h1 id="GIF的合成"><a href="#GIF的合成" class="headerlink" title="GIF的合成"></a>GIF的合成</h1><h6 id="GIF图片合成思路："><a href="#GIF图片合成思路：" class="headerlink" title="GIF图片合成思路："></a>GIF图片合成思路：</h6><p>多帧图像合成GIF的过程和GIF分解多帧图像的过程互逆，GIF图片分解过程倒过来推，就是GIF图像合成的过程。<br>从功能上来说，GIF图片的合成分为以下三个主要部分。<br>（1）加载待处理的n张原始数据源。<br>（2）在Document目录下构建GIF文件。<br>（3）设置GIF文件属性，利用ImageIO编码GIF文件。</p>
<p>1.首先将图片加入到工程中<br><img src="http://upload-images.jianshu.io/upload_images/2478081-df10989d1514fa0e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt="图片导入到bundle中"><br>然后将读取的图片依次加载到images中。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> bundlePath <span class="operator">=</span> <span class="type">Bundle</span>.main.path(forResource: <span class="string">&quot;images&quot;</span>, ofType: <span class="string">&quot;bundle&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;bundlePath === <span class="subst">\(bundlePath)</span>&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> images <span class="operator">=</span> [<span class="type">UIImage</span>]()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span> <span class="operator">..&lt;</span> <span class="number">10</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> path <span class="operator">=</span> bundlePath<span class="operator">?</span>.appending(<span class="string">&quot;/<span class="subst">\(i)</span>.tiff&quot;</span>)</span><br><span class="line">    <span class="keyword">let</span> image <span class="operator">=</span> <span class="type">UIImage</span>.<span class="keyword">init</span>(contentsOfFile: path<span class="operator">!</span>)</span><br><span class="line">    images.append(image<span class="operator">!</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.构建在Document目录下的GIF文件路径。具体实现如下所示。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构建在Document目录下的GIF文件路径</span></span><br><span class="line"><span class="keyword">let</span> docs <span class="operator">=</span> <span class="type">NSSearchPathForDirectoriesInDomains</span>(.documentDirectory, .userDomainMask, <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">let</span> documentsDirectory <span class="operator">=</span> docs[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">String</span></span><br><span class="line"><span class="keyword">let</span> gifPath <span class="operator">=</span> documentsDirectory<span class="operator">+</span><span class="string">&quot;/mine.gif&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;gifPath === <span class="subst">\(gifPath)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> url <span class="operator">=</span> <span class="type">CFURLCreateWithFileSystemPath</span>(kCFAllocatorDefault, gifPath <span class="keyword">as</span> <span class="type">CFString</span>, <span class="type">CFURLPathStyle</span>.cfurlposixPathStyle, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">let</span> destion <span class="operator">=</span> <span class="type">CGImageDestinationCreateWithURL</span>(url<span class="operator">!</span>, kUTTypeGIF, images.count, <span class="literal">nil</span>)</span><br><span class="line"><span class="comment">//CGImageDestinationCreateWithURL方法的作用是创建一个图片的目标对象，为了便于大家理解，这里把图片目标对象比喻为一个集合体。 </span></span><br><span class="line"><span class="comment">//集合体中描述了构成当前图片目标对象的一系列参数，如图片的URL地址、图片类型、图片帧数、配置参数等。</span></span><br><span class="line"><span class="comment">//本代码中将mine.gif的本地文件路径作为参数1传递给这个图片目标对象，参数2描述了图片的类型为GIF图片，参数3表明当前GIF图片构成的帧数，参数4暂时给它一个空值。</span></span><br></pre></td></tr></table></figure>
<p>3.待处理图片源已经加载到代码中，GIF图片Destination也已经完成构建，下面就需要使用ImageIO框架把多帧PNG图片编码到GIF图片中，其处理流程如下。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置gif图片属性，利用9张tiff图片构建gif</span></span><br><span class="line"><span class="keyword">let</span> cgimagePropertiesDic <span class="operator">=</span> [kCGImagePropertyGIFDelayTime <span class="keyword">as</span> <span class="type">String</span>: <span class="number">0.1</span>]<span class="comment">//设置每帧之间播放时间</span></span><br><span class="line"><span class="keyword">let</span> cgimagePropertiesDestDic <span class="operator">=</span> [kCGImagePropertyGIFDictionary <span class="keyword">as</span> <span class="type">String</span>: cgimagePropertiesDic]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> cgimage <span class="keyword">in</span> images &#123;</span><br><span class="line">    <span class="comment">// 依次为gif图像对象添加每一帧元素</span></span><br><span class="line">    <span class="type">CGImageDestinationAddImage</span>(destion<span class="operator">!</span>, cgimage.cgImage<span class="operator">!</span>, cgimagePropertiesDestDic <span class="keyword">as</span> <span class="type">CFDictionary</span>?)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> gifPropertiesDic:<span class="type">NSMutableDictionary</span> <span class="operator">=</span> <span class="type">NSMutableDictionary</span>()</span><br><span class="line">gifPropertiesDic.setValue(kCGImagePropertyColorModelRGB, forKey: kCGImagePropertyColorModel <span class="keyword">as</span> <span class="type">String</span>)</span><br><span class="line">gifPropertiesDic.setValue(<span class="number">16</span>, forKey:kCGImagePropertyDepth <span class="keyword">as</span> <span class="type">String</span>)<span class="comment">// 设置图像的颜色深度</span></span><br><span class="line">gifPropertiesDic.setValue(<span class="number">3</span>, forKey:kCGImagePropertyGIFLoopCount <span class="keyword">as</span> <span class="type">String</span>)<span class="comment">// 设置Gif执行次数, 0则为无限执行</span></span><br><span class="line">gifPropertiesDic.setValue(<span class="type">NSNumber</span>.<span class="keyword">init</span>(booleanLiteral: <span class="literal">true</span>), forKey: kCGImagePropertyGIFHasGlobalColorMap <span class="keyword">as</span> <span class="type">String</span>)</span><br><span class="line"><span class="keyword">let</span> gifDictionaryDestDic <span class="operator">=</span> [kCGImagePropertyGIFDictionary <span class="keyword">as</span> <span class="type">String</span>: gifPropertiesDic]</span><br><span class="line"><span class="type">CGImageDestinationSetProperties</span>(destion<span class="operator">!</span>, gifDictionaryDestDic <span class="keyword">as</span> <span class="type">CFDictionary</span>?)<span class="comment">//为gif图像设置属性</span></span><br><span class="line"></span><br><span class="line"><span class="type">CGImageDestinationFinalize</span>(destion<span class="operator">!</span>)<span class="comment">//最后释放 目标对象 destion</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//生成GIF图片成功</span></span><br></pre></td></tr></table></figure>
<p>这样就生成GIF图片成功了，最后我们来测试一下生成的GIF图片能否成功显示。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试一下显示GIF图片</span></span><br><span class="line"><span class="keyword">let</span> (images2, duration) <span class="operator">=</span> showGif(path: gifPath)<span class="operator">!</span></span><br><span class="line"><span class="keyword">let</span> animatedImage <span class="operator">=</span> <span class="type">UIImage</span>.animatedImage(with: images2, duration: duration)</span><br><span class="line">imageView <span class="operator">=</span> <span class="type">UIImageView</span>.<span class="keyword">init</span>(image: animatedImage)</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.view.addSubview(imageView<span class="operator">!</span>)</span><br><span class="line">imageView<span class="operator">?</span>.center <span class="operator">=</span> <span class="keyword">self</span>.view.center</span><br></pre></td></tr></table></figure>
<p><strong>运行之后确实是可以显示的</strong><br><img src="http://upload-images.jianshu.io/upload_images/2478081-fa8bf6dab9678aca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/300" alt="大功告成！"></p>
<h1 id="最后的话"><a href="#最后的话" class="headerlink" title="最后的话"></a>最后的话</h1><p>最后附上demo 的地址<br><a target="_blank" rel="noopener" href="https://github.com/aichiko/Swift_Diary">https://github.com/aichiko/Swift_Diary</a><br>喜欢的话可以点赞一下。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://aichiko0225.github.com/memoirs/2017/02/11/iOS/ios-gif/" data-id="cm4i68dvd0024b6evc9nnbxlx" data-title="iOS GIF图片的加载和合成" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/memoirs/2017/07/06/linux/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          Linux 基础
        
      </div>
    </a>
  
  
    <a href="/memoirs/2017/02/03/%E9%97%AE%E9%81%93/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">问道</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/memoirs/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/memoirs/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/memoirs/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/memoirs/categories/%E5%85%B3%E4%BA%8E%E4%B8%96%E7%95%8C%E7%9A%84%E4%B8%80%E5%88%87/">关于世界的一切</a></li><li class="category-list-item"><a class="category-list-link" href="/memoirs/categories/%E5%B7%A5%E4%BD%9C%E6%97%A5%E5%B8%B8/">工作日常</a></li><li class="category-list-item"><a class="category-list-link" href="/memoirs/categories/%E6%AD%A6%E6%B1%89/">武汉</a></li><li class="category-list-item"><a class="category-list-link" href="/memoirs/categories/%E9%80%86%E5%90%91/">逆向</a></li><li class="category-list-item"><a class="category-list-link" href="/memoirs/categories/%E9%9A%8F%E4%BE%BF%E5%86%99%E5%86%99/">随便写写</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/memoirs/tags/Flask/" rel="tag">Flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/memoirs/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/memoirs/tags/Runtime/" rel="tag">Runtime</a></li><li class="tag-list-item"><a class="tag-list-link" href="/memoirs/tags/Web/" rel="tag">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/memoirs/tags/iOS/" rel="tag">iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/memoirs/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="tag">基础知识</a></li><li class="tag-list-item"><a class="tag-list-link" href="/memoirs/tags/%E6%9D%82%E8%B0%88/" rel="tag">杂谈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/memoirs/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/memoirs/tags/Flask/" style="font-size: 13.33px;">Flask</a> <a href="/memoirs/tags/React/" style="font-size: 10px;">React</a> <a href="/memoirs/tags/Runtime/" style="font-size: 10px;">Runtime</a> <a href="/memoirs/tags/Web/" style="font-size: 13.33px;">Web</a> <a href="/memoirs/tags/iOS/" style="font-size: 16.67px;">iOS</a> <a href="/memoirs/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 20px;">基础知识</a> <a href="/memoirs/tags/%E6%9D%82%E8%B0%88/" style="font-size: 16.67px;">杂谈</a> <a href="/memoirs/tags/%E9%80%86%E5%90%91/" style="font-size: 13.33px;">逆向</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2021/09/">九月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2021/08/">八月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2021/07/">七月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/memoirs/archives/2016/11/">十一月 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/memoirs/2021/09/15/%E4%B9%A1%E5%9C%9F%E4%B8%AD%E5%9B%BD/">乡土中国</a>
          </li>
        
          <li>
            <a href="/memoirs/2021/08/20/%E5%A5%97%E8%B7%AF%E7%9C%9F%E5%A4%9A/">套路真多</a>
          </li>
        
          <li>
            <a href="/memoirs/2021/07/29/%E4%B9%8C%E5%90%88%E4%B9%8B%E4%BC%97/">乌合之众</a>
          </li>
        
          <li>
            <a href="/memoirs/2021/06/19/ReactStack-1/">React 技术栈（一）</a>
          </li>
        
          <li>
            <a href="/memoirs/2020/11/02/JavaScript-study-record-2/">JavaScript 温习记录（二）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 ash<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/memoirs/" class="mobile-nav-link">Home</a>
  
    <a href="/memoirs/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/memoirs/js/jquery-3.6.4.min.js"></script>



  
<script src="/memoirs/fancybox/jquery.fancybox.min.js"></script>




<script src="/memoirs/js/script.js"></script>





  </div>
</body>
</html>